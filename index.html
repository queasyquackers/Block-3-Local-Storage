<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice Exam Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-main: #f3f4f6; --bg-card: #ffffff; --bg-card-subtle: #f9fafb; --bg-hover: #eff6ff; --bg-selected: #dbeafe;
            --text-primary: #1f2937; --text-secondary: #4b5563;
            --border-color: #d1d5db; --border-accent: #3b82f6;
            --accent-color: #3b82f6; --accent-text: #3b82f6;
            --correct-bg: #dcfce7; --correct-border: #22c55e; --correct-text: #166534;
            --incorrect-bg: #fee2e2; --incorrect-border: #ef4444; --incorrect-text: #991b1b;
        }
        body.dark-mode {
            --bg-main: #111827; --bg-card: #1f2937; --bg-card-subtle: #374151; --bg-hover: #374151; --bg-selected: #1e40af;
            --text-primary: #f9fafb; --text-secondary: #d1d5db;
            --border-color: #4b5563; --border-accent: #60a5fa;
            --accent-color: #60a5fa; --accent-text: #60a5fa;
            --correct-bg: #14532d; --correct-border: #4ade80; --correct-text: #bbf7d0;
            --incorrect-bg: #7f1d1d; --incorrect-border: #f87171; --incorrect-text: #fecaca;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-main); color: var(--text-primary); transition: background-color 0.2s, color 0.2s; }
        .card { background-color: var(--bg-card); transition: background-color 0.2s; }
        .subtle-card { background-color: var(--bg-card-subtle); transition: background-color 0.2s; }
        .text-secondary { color: var(--text-secondary); }
        .border-default { border-color: var(--border-color); }
        .tab-active { border-bottom-color: var(--accent-color); color: var(--accent-text); }
        .test-selector-btn-active { background-color: var(--accent-color); color: white; }
        .test-selector-btn-inactive { background-color: var(--bg-main); color: var(--text-secondary); }
        .q-grid-btn { transition: all 0.2s ease-in-out; border-color: var(--border-color); }
        .q-grid-btn-current { background-color: #374151; color: white; transform: scale(1.1); }
        .q-grid-btn-answered { background-color: #3b82f6; color: white; }
        .q-grid-btn-flagged { background-color: #f59e0b; color: white; }
        .q-grid-btn-correct { background-color: #22c55e; color: white; border-color: #16a34a; }
        .q-grid-btn-incorrect { background-color: #ef4444; color: white; border-color: #dc2626; }
        .test-selector-btn { padding: 8px 16px; border-radius: 6px; font-weight: 500; transition: background-color 0.2s; }
        .option-btn { border: 1px solid var(--border-color); transition: background-color 0.2s, border-color 0.2s; }
        .option-btn:hover { background-color: var(--bg-hover); border-color: var(--border-accent); }
        .option-btn-selected { background-color: var(--bg-selected); border-color: var(--border-accent); box-shadow: 0 0 0 2px var(--accent-color); }
        .option-btn-correct { background-color: var(--correct-bg); border-color: var(--correct-border); color: var(--correct-text); }
        .option-btn-incorrect { background-color: var(--incorrect-bg); border-color: var(--incorrect-border); color: var(--incorrect-text); }
        .option-strikethrough { text-decoration: line-through; background-color: var(--bg-main) !important; color: var(--text-secondary) !important; opacity: 0.7; }
        .explanation { display: none; margin-top: 0.5rem; padding: 0.75rem; border-left: 4px solid var(--border-color); background-color: var(--bg-card-subtle); color: var(--text-secondary); }
    </style>

    <script src="Test2.js"></script>
	<script src="Test1.js"></script>
	<script src="Test3.js"></script>
	<script src="Test4.js"></script>
	<script src="Test5.js"></script>
	<script src="Test6.js"></script>
	<script src="Test7.js"></script>
	

</head>
<body>
    <script>
        if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); }
    </script>

    <div id="app-container" class="container mx-auto max-w-7xl p-4">
        <nav class="card shadow-md mb-6 p-4 rounded-lg">
            <h2 class="text-xl font-bold text-center mb-3">Select an Exam</h2>
            <div id="test-selector-nav" class="flex flex-wrap justify-center gap-3"></div>
        </nav>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <aside class="card md:col-span-1 p-4 rounded-lg shadow-md h-full md:sticky top-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Exam Control</h2>
                    <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                        <svg id="theme-icon-light" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <svg id="theme-icon-dark" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                </div>
                <div class="subtle-card text-center p-4 rounded-lg mb-4">
                    <div id="timer-display" class="text-3xl font-mono font-bold text-secondary">00:00</div>
                    <div class="flex justify-center space-x-2 mt-2">
                        <button id="timer-start-btn" class="text-sm bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded">Start</button>
                        <button id="timer-pause-btn" class="hidden text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-1 px-3 rounded">Pause</button>
                    </div>
                </div>
                <h3 class="font-semibold mb-2 text-center">Question Navigator</h3>
                <div id="question-grid" class="grid grid-cols-5 gap-2 mb-4"></div>
                <div class="text-xs text-secondary mb-4">
                    <div class="flex items-center"><span class="w-3 h-3 border border-default rounded-full mr-2"></span>Not Answered</div>
                    <div class="flex items-center mt-1"><span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>Answered</div>
                    <div class="flex items-center mt-1"><span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>Flagged</div>
                    <div class="flex items-center mt-1"><span class="w-3 h-3 bg-gray-700 rounded-full mr-2"></span>Current</div>
                </div>
                <button id="finish-test-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                    Finish & Grade Exam
                </button>
                <button id="reset-progress-btn" class="w-full mt-2 text-sm text-center text-secondary hover:text-red-600">
                    Reset Progress
                </button>
            </aside>
            <main class="md:col-span-3">
                 <header class="card rounded-t-lg shadow-md p-6">
                    <h1 id="exam-title" class="text-2xl font-bold">Practice Exam</h1>
                    <div class="border-b border-default mt-4">
                        <nav class="-mb-px flex" aria-label="Tabs">
                            <button id="tab-test" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm tab-active">
                                Practice Test
                            </button>
                            <button id="tab-summary" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm text-gray-500 border-transparent disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Review Summary
                            </button>
                        </nav>
                    </div>
                </header>
                <div id="main-content-area" class="card rounded-b-lg shadow-md p-6">
                    <div id="test-view">
                         <div id="question-header" class="flex justify-between items-center mb-6">
                            <h2 id="question-counter" class="text-xl font-semibold">Question 1 of N</h2>
                             <button id="flag-question-btn" class="flex items-center text-gray-500 hover:text-yellow-500 font-semibold py-1 px-3 rounded-full border border-default hover:border-yellow-400 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6H8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path></svg>
                                <span id="flag-btn-text">Flag for Review</span>
                            </button>
                        </div>
                        <div id="question-container"></div>
                        <div id="navigation-container" class="mt-8 flex justify-between items-center border-t border-default pt-6"></div>
                    </div>
                    <div id="summary-view" class="hidden">
                        <div id="summary-dashboard">
                            <h2 class="text-2xl font-bold text-center mb-6">Test Completed!</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                                <div class="flex flex-col items-center">
                                    <div class="max-w-xs w-full"><canvas id="performance-chart"></canvas></div>
                                </div>
                                <div class="text-center md:text-left">
                                    <h3 class="text-lg font-semibold mb-2">Final Score</h3>
                                    <p id="final-score" class="text-5xl font-bold" style="color: var(--accent-text)"></p>
                                    <p id="final-percentage" class="text-2xl text-secondary mb-6"></p>
                                    <h3 class="text-lg font-semibold mb-2">Performance Overview</h3>
                                    <div id="performance-overview"></div>
                                </div>
                            </div>
                            <div class="mt-10 flex flex-col sm:flex-row gap-4 justify-center">
                                <button id="view-all-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white font-bold py-2 px-4 rounded">Review All</button>
                                <button id="view-incorrect-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Review Incorrect</button>
                            </div>
                            <div class="mt-12 border-t border-default pt-6">
                                <h3 class="text-lg font-semibold text-center mb-4">Generate Study Prompt</h3>
                                <div class="flex justify-center">
                                    <button id="generate-prompt-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">Generate Prompt for Weak Areas</button>
                                </div>
                                <textarea id="prompt-output-area" class="mt-4 w-full h-48 p-2 border border-default rounded subtle-card text-secondary text-sm" readonly placeholder="Your study prompt will appear here..."></textarea>
                            </div>
                        </div>
                        <div id="detailed-review-view" class="hidden">
                            <button id="back-to-summary-btn" class="mb-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">&larr; Back to Summary</button>
                            <div id="detailed-questions-container"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div id="finish-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div id="modal-backdrop" class="absolute inset-0"></div>
        <div id="modal-content" class="card shadow-xl p-6 w-full max-w-md z-10">
            <h3 class="text-xl font-bold">Finish Exam?</h3>
            <p id="modal-text" class="text-secondary my-4">Are you sure you want to finish and grade the exam? Any unanswered questions will be marked incorrect.</p>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Finish Exam</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const testsToLoad = [
                { name: "OMM Lumbar Dx", data: L102 },
				{ name: "H&N Anatomy", data: L103 },
				{ name: "H&N Embryology", data: L104 },
				{ name: "H&N Pathways", data: L105 },
				{ name: "DPR Health Disparities", data: L106 },
				{ name: "Pharmacodynamics", data: L107L108 },
				{ name: "Pharmacokinetics", data: L109L110 }
            ];

            // Store state for ALL tests in memory
            const testStates = {};
            
            let currentTestName = '';
            let performanceChart = null;

            // Function to get current test state
            const getCurrentTestState = () => {
                if (!currentTestName || !testStates[currentTestName]) return null;
                return testStates[currentTestName];
            };

            const getEl = (id) => document.getElementById(id);

            const darkModeToggle = getEl('dark-mode-toggle');
            const lightIcon = getEl('theme-icon-light');
            const darkIcon = getEl('theme-icon-dark');
            
            const updateThemeIcons = () => {
                if (document.body.classList.contains('dark-mode')) {
                    lightIcon.classList.add('hidden');
                    darkIcon.classList.remove('hidden');
                } else {
                    darkIcon.classList.add('hidden');
                    lightIcon.classList.remove('hidden');
                }
            };

            darkModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                updateThemeIcons();
            });

            const generatePromptBtn = getEl('generate-prompt-btn');
            const promptOutputArea = getEl('prompt-output-area');
            generatePromptBtn.addEventListener('click', () => {
                const state = getCurrentTestState();
                if (!state) return;
                
                const numberOfQuestions = 10;
                const weakCategories = Object.entries(state.currentSummaryStats)
                    .filter(([_, stats]) => stats.correct < stats.total)
                    .sort(([, a], [, b]) => (a.correct / a.total) - (b.correct / b.total));

                let dynamicInputText = "";
                if (weakCategories.length === 0) {
                    const allCategories = Object.keys(state.currentSummaryStats).join(', ');
                    dynamicInputText = `I did not get any questions wrong on this test. Please generate a mixed review set from all topics covered (${allCategories}).`;
                } else {
                    dynamicInputText = "The following list contains my weak areas from the test, ranked from weakest to strongest. Please create more questions related to the topics at the top of this list:\n";
                    weakCategories.forEach(([category, stats]) => {
                        const percent = ((stats.correct / stats.total) * 100).toFixed(0);
                        dynamicInputText += `- ${category}: Scored ${percent}% (${stats.correct}/${stats.total})\n`;
                    });
                }

                const fullPrompt = `# Persona
Act as a board question writer with expertise in creating high-quality USMLE Step 1 and COMLEX Level 1 style questions for a first-year osteopathic medical student (OMS1).

# Task
Create ${numberOfQuestions} challenging, second-order test questions.

# Question Formatting Rules
- **Style:** Each question should be a clinical vignette where appropriate, requiring clinical reasoning.
- **Choices:** Provide 5 answer choices (A-E).
- **Source Material:** Base the questions **only** on the information and topics covered in the provided source documents.
- **Topics:** Focus on the topics listed under "Dynamic Inputs" below.
- **Quality:** Do not create simple recall questions. Ensure questions are distinct and do not repeat concepts excessively.

# Answer & Explanation Formatting Rules
- Clearly identify the correct answer.
- Provide a 1-2 sentence explanation for why the correct answer is right.
- Provide a separate, 1-2 sentence explanation for why **every other** answer choice is wrong.
- Include relevant mnemonics in the explanations where appropriate (but not in the question or answers).

# Dynamic Inputs
${dynamicInputText}

# Output Format
You MUST provide the final output as a single, valid JavaScript code block containing an array of question objects, exactly matching the format below. Do not include any text, headings, or explanations outside of this code block.

\`\`\`javascript
const newTestData = [
    {
        "id": 1,
        "category": "Generated Topic",
        "questionText": "A clinical vignette or question stem goes here...",
        "options": [
            {"text": "Answer Choice A", "explanation": "Explanation for why A is right or wrong."},
            {"text": "Answer Choice B", "explanation": "Explanation for why B is right or wrong."},
            {"text": "Answer Choice C", "explanation": "Explanation for why C is right or wrong."},
            {"text": "Answer Choice D", "explanation": "Explanation for why D is right or wrong."},
            {"text": "Answer Choice E", "explanation": "Explanation for why E is right or wrong."}
        ],
        "correctAnswerIndex": 2
    }
];
\`\`\``;

                promptOutputArea.value = fullPrompt.trim();
            });

            const handleSubmit = () => {
                const state = getCurrentTestState();
                if (!state || state.examFinished) return;
                const answerState = state.userAnswers[state.currentQuestionIndex];
                if (answerState.selectedIndex === null) {
                    alert('Please select an answer before submitting.');
                    return;
                }
                answerState.isSubmitted = true;
                answerState.isCorrect = answerState.selectedIndex === state.questions[state.currentQuestionIndex].correctAnswerIndex;
                answerState.strikedOutIndices.clear();
                displayQuestion();
                saveState();
            };
            
            const generateSummary = (testName) => {
                const state = testStates[testName];
                if (!state) return;
                
                const score = state.userAnswers.filter(a => a.isCorrect).length;
                const totalQuestions = state.questions.length;
                const percentage = totalQuestions > 0 ? (score / totalQuestions * 100).toFixed(1) : 0;
                getEl('final-score').textContent = `${score} / ${totalQuestions}`;
                getEl('final-percentage').textContent = `${percentage}%`;
                const correctCount = score;
                const incorrectCount = totalQuestions - score;
                if (performanceChart) performanceChart.destroy();
                const ctx = getEl('performance-chart').getContext('2d');
                performanceChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: ['Correct', 'Incorrect'], datasets: [{ data: [correctCount, incorrectCount], backgroundColor: ['rgba(75, 192, 192, 0.8)', 'rgba(255, 99, 132, 0.8)'], borderColor: 'var(--bg-card)', borderWidth: 4 }] },
                    options: { responsive: true, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw} (${((c.raw / totalQuestions) * 100).toFixed(0)}%)` } } } }
                });

                const categoryStats = {};
                state.questions.forEach((q, index) => {
                    if (!categoryStats[q.category]) categoryStats[q.category] = { correct: 0, total: 0 };
                    if (state.userAnswers[index].isSubmitted) {
                        categoryStats[q.category].total++;
                        if (state.userAnswers[index].isCorrect) categoryStats[q.category].correct++;
                    }
                });
                state.currentSummaryStats = categoryStats;
                
                const perfArray = Object.entries(categoryStats).map(([name, stats]) => ({
                    name,
                    score: stats.total > 0 ? (stats.correct / stats.total) : 0,
                    stats: `${stats.correct} / ${stats.total}`
                })).sort((a, b) => a.score - b.score);

                const overviewContainer = getEl('performance-overview');
                overviewContainer.innerHTML = '';
                
                const weakest = perfArray.slice(0, 3);
                const strongest = perfArray.length > 3 ? perfArray.slice(-3).reverse() : [];

                let html = '';
                if (weakest.length > 0) {
                    html += `<h4 class="font-semibold text-red-500">Areas for Review</h4>`;
                    weakest.forEach(item => {
                        html += `<p class="text-sm text-secondary">${item.name} - ${item.stats} (${(item.score * 100).toFixed(0)}%)</p>`;
                    });
                }
                if (strongest.length > 0) {
                    html += `<h4 class="font-semibold text-green-500 mt-4">Strongest Areas</h4>`;
                    strongest.forEach(item => {
                        html += `<p class="text-sm text-secondary">${item.name} - ${item.stats} (${(item.score * 100).toFixed(0)}%)</p>`;
                    });
                }
                overviewContainer.innerHTML = html;
                promptOutputArea.value = '';
            };
            
            function switchToTest(testName) {
                // Save current test state before switching
                if (currentTestName && testStates[currentTestName]) {
                    saveState();
                }
                
                currentTestName = testName;
                const state = testStates[testName];
                if (!state) return;
                
                // Update UI elements
                getEl('exam-title').textContent = `Practice Exam: ${testName}`;
                const selectorBtns = getEl('test-selector-nav').querySelectorAll('button');
                selectorBtns.forEach(btn => {
                    btn.classList.toggle('test-selector-btn-active', btn.dataset.name === testName);
                    btn.classList.toggle('test-selector-btn-inactive', btn.dataset.name !== testName);
                });
                
                // Restore timer display
                getEl('timer-display').textContent = formatTime(Math.floor(state.timer.elapsedTime / 1000));
                
                // Update button states
                getEl('finish-test-btn').disabled = state.examFinished;
                getEl('flag-question-btn').disabled = state.examFinished;
                getEl('timer-start-btn').disabled = state.examFinished;
                getEl('timer-pause-btn').disabled = state.examFinished;
                
                // Update tabs
                const summaryTab = getEl('tab-summary');
                summaryTab.disabled = !state.examFinished;
                if (state.examFinished) {
                    summaryTab.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
                } else {
                    summaryTab.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
                }
                
                // Show correct view
                if (state.examFinished) {
                    getEl('tab-summary').click();
                    generateSummary(testName);
                } else {
                    getEl('tab-test').click();
                }
                
                // Update timer button visibility
                if (state.timer.isRunning) {
                    getEl('timer-start-btn').classList.add('hidden');
                    getEl('timer-pause-btn').classList.remove('hidden');
                } else {
                    getEl('timer-start-btn').classList.remove('hidden');
                    getEl('timer-pause-btn').classList.add('hidden');
                    getEl('timer-start-btn').textContent = state.timer.elapsedTime > 0 ? 'Resume' : 'Start';
                }
                
                renderSidebar();
                displayQuestion();
            }
            
            function loadTest(testObject) {
                // Check if test already has a state
                if (!testStates[testObject.name]) {
                    // Initialize new test state
                    testStates[testObject.name] = {
                        questions: testObject.data,
                        currentQuestionIndex: 0,
                        userAnswers: [],
                        flaggedQuestions: new Set(),
                        timer: { interval: null, startTime: 0, elapsedTime: 0, isRunning: false },
                        examFinished: false,
                        currentSummaryStats: {}
                    };
                    
                    // Try to load from localStorage
                    const LOCAL_STORAGE_KEY = `examProgress_${testObject.name}`;
                    const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (savedState) {
                        const parsedState = JSON.parse(savedState);
                        const state = testStates[testObject.name];
                        state.currentQuestionIndex = parsedState.currentQuestionIndex;
                        state.userAnswers = parsedState.userAnswers.map(a => ({...a, strikedOutIndices: new Set(a.strikedOutIndices)}));
                        state.flaggedQuestions = new Set(parsedState.flaggedQuestions);
                        state.timer.elapsedTime = parsedState.timer.elapsedTime;
                    } else {
                        // Initialize fresh user answers
                        const state = testStates[testObject.name];
                        state.userAnswers = Array(state.questions.length).fill(null).map(() => ({ 
                            selectedIndex: null, 
                            isSubmitted: false, 
                            isCorrect: false, 
                            strikedOutIndices: new Set() 
                        }));
                    }
                }
                
                switchToTest(testObject.name);
            }
            
            function createTestSelector() { 
                const navContainer = getEl('test-selector-nav'); 
                navContainer.innerHTML = ''; 
                testsToLoad.forEach(testObj => { 
                    const button = document.createElement('button'); 
                    button.textContent = testObj.name; 
                    button.dataset.name = testObj.name; 
                    button.className = 'test-selector-btn test-selector-btn-inactive'; 
                    button.onclick = () => loadTest(testObj); 
                    navContainer.appendChild(button); 
                }); 
            }
            
            const finishTest = () => {
                hideModal();
                const state = getCurrentTestState();
                if (!state) return;
                
                state.examFinished = true;
                pauseTimer();
                state.userAnswers.forEach(ans => {
                    if (!ans.isSubmitted) {
                        ans.isSubmitted = true;
                        ans.isCorrect = false;
                    }
                });
                
                let score = 0;
                state.userAnswers.forEach(ans => { if(ans.isCorrect) score++ });
                
                getEl('finish-test-btn').disabled = true;
                getEl('flag-question-btn').disabled = true;
                getEl('timer-start-btn').disabled = true;
                getEl('timer-pause-btn').disabled = true;
                
                const summaryTab = getEl('tab-summary');
                summaryTab.disabled = false;
                summaryTab.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
                summaryTab.click();
                
                localStorage.removeItem(`examProgress_${currentTestName}`);
                generateSummary(currentTestName);
                
                const navButtons = getEl('question-grid').querySelectorAll('button');
                navButtons.forEach((btn, index) => {
                    btn.classList.remove('q-grid-btn-answered', 'q-grid-btn-flagged');
                    if(state.userAnswers[index].isCorrect) {
                        btn.classList.add('q-grid-btn-correct');
                    } else {
                        btn.classList.add('q-grid-btn-incorrect');
                    }
                });
            };
            
            const handleTabClick = (e) => {
                const target = e.currentTarget;
                if (target.disabled) return;
                const testTab = getEl('tab-test');
                const summaryTab = getEl('tab-summary');
                const testView = getEl('test-view');
                const summaryView = getEl('summary-view');
                testTab.classList.remove('tab-active');
                testTab.classList.add('text-gray-500', 'border-transparent');
                summaryTab.classList.remove('tab-active');
                summaryTab.classList.add('text-gray-500', 'border-transparent');
                if (target.id === 'tab-test') {
                    summaryView.classList.add('hidden');
                    testView.classList.remove('hidden');
                    testTab.classList.add('tab-active');
                    testTab.classList.remove('text-gray-500', 'border-transparent');
                } else {
                    testView.classList.add('hidden');
                    summaryView.classList.remove('hidden');
                    summaryTab.classList.add('tab-active');
                    summaryTab.classList.remove('text-gray-500', 'border-transparent');
                    getEl('detailed-review-view').classList.add('hidden');
                    getEl('summary-dashboard').classList.remove('hidden');
                }
            };
            
            const displayQuestion = () => {
                const state = getCurrentTestState();
                if (!state || state.questions.length === 0) return;
                
                const question = state.questions[state.currentQuestionIndex];
                const answerState = state.userAnswers[state.currentQuestionIndex];
                const questionContainer = getEl('question-container');
                const navigationContainer = getEl('navigation-container');
                questionContainer.innerHTML = '';
                navigationContainer.innerHTML = '';
                getEl('question-counter').textContent = `Question ${state.currentQuestionIndex + 1} of ${state.questions.length}`;
                
                // Update flag button
                if (state.flaggedQuestions.has(state.currentQuestionIndex)) {
                    getEl('flag-btn-text').textContent = 'Unflag';
                    getEl('flag-question-btn').classList.add('text-yellow-500');
                } else {
                    getEl('flag-btn-text').textContent = 'Flag for Review';
                    getEl('flag-question-btn').classList.remove('text-yellow-500');
                }
                
                const qText = document.createElement('p');
                qText.className = 'text-lg leading-relaxed mb-6';
                qText.textContent = question.questionText;
                questionContainer.appendChild(qText);
                
                const optsContainer = document.createElement('div');
                optsContainer.className = 'space-y-3';
                question.options.forEach((opt, index) => {
                    const wrapper = document.createElement('div');
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-4 rounded-lg option-btn';
                    btn.dataset.index = index;
                    btn.innerHTML = `<span class="font-bold mr-2">${String.fromCharCode(65 + index)}.</span> ${opt.text}`;
                    if (answerState.strikedOutIndices.has(index)) btn.classList.add('option-strikethrough');
                    const explanationEl = document.createElement('div');
                    explanationEl.className = 'explanation';
                    explanationEl.textContent = opt.explanation;
                    if (answerState.isSubmitted) {
                        btn.disabled = true;
                        explanationEl.style.display = 'block';
                        btn.classList.remove('option-btn-selected');
                        if (index === question.correctAnswerIndex) btn.classList.add('option-btn-correct');
                        else if (index === answerState.selectedIndex) btn.classList.add('option-btn-incorrect');
                    } else {
                        if (answerState.selectedIndex === index) btn.classList.add('option-btn-selected');
                    }
                    wrapper.appendChild(btn);
                    wrapper.appendChild(explanationEl);
                    optsContainer.appendChild(wrapper);
                });
                questionContainer.appendChild(optsContainer);
                
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '← Previous';
                prevBtn.className = 'bg-gray-200 hover:bg-gray-300 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white font-bold py-2 px-6 rounded disabled:opacity-50';
                if (state.currentQuestionIndex === 0) prevBtn.disabled = true;
                prevBtn.onclick = () => changeQuestion(-1);
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Next →';
                nextBtn.className = 'bg-gray-200 hover:bg-gray-300 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white font-bold py-2 px-6 rounded disabled:opacity-50';
                if (state.currentQuestionIndex === state.questions.length - 1) nextBtn.disabled = true;
                nextBtn.onclick = () => changeQuestion(1);
                navigationContainer.appendChild(prevBtn);
                if (!answerState.isSubmitted) {
                    const submitBtn = document.createElement('button');
                    submitBtn.textContent = 'Submit Answer';
                    submitBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded';
                    submitBtn.onclick = handleSubmit;
                    navigationContainer.appendChild(submitBtn);
                }
                navigationContainer.appendChild(nextBtn);
                updateSidebarState();
            };
            
            const handleStrikeThrough = (e) => {
                e.preventDefault();
                const state = getCurrentTestState();
                if (!state || state.examFinished || state.userAnswers[state.currentQuestionIndex].isSubmitted) return;
                const targetButton = e.target.closest('button[data-index]');
                if (!targetButton) return;
                const index = parseInt(targetButton.dataset.index);
                const strikedOutSet = state.userAnswers[state.currentQuestionIndex].strikedOutIndices;
                if (strikedOutSet.has(index)) {
                    strikedOutSet.delete(index);
                } else {
                    strikedOutSet.add(index);
                }
                targetButton.classList.toggle('option-strikethrough');
                saveState();
            };
            
            const saveState = () => {
                const state = getCurrentTestState();
                if(!state || state.examFinished) return;
                const LOCAL_STORAGE_KEY = `examProgress_${currentTestName}`;
                const stateToSave = {
                    currentQuestionIndex: state.currentQuestionIndex,
                    userAnswers: state.userAnswers.map(a => ({...a, strikedOutIndices: Array.from(a.strikedOutIndices)})),
                    flaggedQuestions: Array.from(state.flaggedQuestions),
                    timer: { elapsedTime: state.timer.elapsedTime + (state.timer.isRunning ? Date.now() - state.timer.startTime : 0) }
                };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(stateToSave));
            };
            
            const resetState = () => {
                if(confirm("Are you sure you want to reset all progress for this test? This cannot be undone.")) {
                    pauseTimer();
                    const LOCAL_STORAGE_KEY = `examProgress_${currentTestName}`;
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    
                    // Reset the in-memory state
                    const testObject = testsToLoad.find(t => t.name === currentTestName);
                    delete testStates[currentTestName];
                    
                    // Reload the test
                    loadTest(testObject);
                }
            };
            
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                return `${mins}:${secs}`;
            };
            
            const updateTimer = () => {
                const state = getCurrentTestState();
                if (!state) return;
                const now = Date.now();
                const totalElapsed = state.timer.elapsedTime + (now - state.timer.startTime);
                getEl('timer-display').textContent = formatTime(Math.floor(totalElapsed / 1000));
            };
            
            const startTimer = () => {
                const state = getCurrentTestState();
                if (!state || state.examFinished || state.timer.isRunning) return;
                state.timer.isRunning = true;
                state.timer.startTime = Date.now();
                state.timer.interval = setInterval(updateTimer, 1000);
                getEl('timer-start-btn').textContent = 'Resume';
                getEl('timer-start-btn').classList.add('hidden');
                getEl('timer-pause-btn').classList.remove('hidden');
            };
            
            const pauseTimer = () => {
                const state = getCurrentTestState();
                if (!state || !state.timer.isRunning) return;
                state.timer.isRunning = false;
                clearInterval(state.timer.interval);
                state.timer.elapsedTime += Date.now() - state.timer.startTime;
                getEl('timer-start-btn').classList.remove('hidden');
                getEl('timer-pause-btn').classList.add('hidden');
                if(!state.examFinished) saveState();
            };
            
            const renderSidebar = () => {
                const state = getCurrentTestState();
                if (!state) return;
                const questionGrid = getEl('question-grid');
                questionGrid.innerHTML = '';
                state.questions.forEach((q, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'q-grid-btn w-10 h-10 flex items-center justify-center rounded-full border border-default text-sm font-semibold';
                    btn.textContent = index + 1;
                    btn.dataset.index = index;
                    questionGrid.appendChild(btn);
                });
                updateSidebarState();
            };
            
            const updateSidebarState = () => {
                const state = getCurrentTestState();
                if (!state) return;
                const buttons = getEl('question-grid').querySelectorAll('button');
                buttons.forEach((btn, index) => {
                    btn.classList.remove('q-grid-btn-current', 'q-grid-btn-answered', 'q-grid-btn-flagged', 'q-grid-btn-correct', 'q-grid-btn-incorrect');
                    if (state.examFinished) {
                        if (state.userAnswers[index].isCorrect) {
                            btn.classList.add('q-grid-btn-correct');
                        } else {
                            btn.classList.add('q-grid-btn-incorrect');
                        }
                    } else {
                        if (state.userAnswers[index]?.isSubmitted) btn.classList.add('q-grid-btn-answered');
                        if (state.flaggedQuestions.has(index)) btn.classList.add('q-grid-btn-flagged');
                        if (index === state.currentQuestionIndex) btn.classList.add('q-grid-btn-current');
                    }
                });
            };
            
            const jumpToQuestion = (index) => {
                const state = getCurrentTestState();
                if (!state) return;
                if (state.examFinished && getEl('summary-view').classList.contains('hidden')) {
                    // Do nothing if in detailed review
                } else if (state.examFinished) {
                    getEl('tab-test').click();
                }
                state.currentQuestionIndex = index;
                displayQuestion();
                if (!state.examFinished) saveState();
            };
            
            const changeQuestion = (direction) => {
                const state = getCurrentTestState();
                if (!state) return;
                const newIndex = state.currentQuestionIndex + direction;
                if(newIndex >= 0 && newIndex < state.questions.length) {
                    jumpToQuestion(newIndex);
                }
            };
            
            const toggleFlag = () => {
                const state = getCurrentTestState();
                if(!state || state.examFinished) return;
                if (state.flaggedQuestions.has(state.currentQuestionIndex)) {
                    state.flaggedQuestions.delete(state.currentQuestionIndex);
                } else {
                    state.flaggedQuestions.add(state.currentQuestionIndex);
                }
                displayQuestion();
                saveState();
            };
            
            const handleSelectAnswer = (e) => {
                const state = getCurrentTestState();
                if (!state || state.examFinished) return;
                const selectedButton = e.target.closest('button[data-index]');
                if (!selectedButton || state.userAnswers[state.currentQuestionIndex].isSubmitted) return;
                const selectedIndex = parseInt(selectedButton.dataset.index);
                state.userAnswers[state.currentQuestionIndex].selectedIndex = selectedIndex;
                displayQuestion();
                saveState();
            };
            
            const showModal = () => {
                const state = getCurrentTestState();
                if (!state) return;
                const unansweredCount = state.userAnswers.filter(a => !a.isSubmitted).length;
                const modalText = getEl('modal-text');
                if(unansweredCount > 0){
                    modalText.innerHTML = `You have <span class="font-bold">${unansweredCount} unanswered</span> questions. Are you sure you want to finish? They will be marked incorrect.`;
                } else {
                    modalText.textContent = "Are you sure you want to finish and grade the exam?";
                }
                getEl('finish-modal').classList.remove('hidden');
            };
            
            const hideModal = () => getEl('finish-modal').classList.add('hidden');
            
            const showDetailedReview = (filterType) => {
                const state = getCurrentTestState();
                if (!state) return;
                getEl('summary-dashboard').classList.add('hidden');
                getEl('detailed-review-view').classList.remove('hidden');
                const container = getEl('detailed-questions-container');
                container.innerHTML = '';
                const questionsToReview = state.questions.filter((q, index) => {
                    if (filterType === 'all') return state.userAnswers[index].isSubmitted;
                    if (filterType === 'incorrect') return state.userAnswers[index].isSubmitted && !state.userAnswers[index].isCorrect;
                    return false;
                });
                if (questionsToReview.length === 0 && filterType === 'incorrect') {
                    container.innerHTML = `<div class="text-center p-8 subtle-card rounded-lg"><h3 class="text-xl font-bold text-green-500">Congratulations!</h3><p class="text-secondary mt-2">You have no incorrect answers to review.</p></div>`;
                    return;
                }
                questionsToReview.forEach((q) => {
                    const originalIndex = state.questions.findIndex(origQ => origQ.id === q.id);
                    const userAnswer = state.userAnswers[originalIndex];
                    const questionEl = document.createElement('div');
                    questionEl.className = 'subtle-card p-6 border border-default rounded-lg mb-6';
                    let optionsHtml = q.options.map((opt, optIndex) => {
                        let indicators = '';
                        if(optIndex === q.correctAnswerIndex) indicators += '<span class="ml-2 text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full">Correct</span>';
                        if (userAnswer.selectedIndex === optIndex && !userAnswer.isCorrect) indicators += '<span class="ml-2 text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full">Your Answer</span>';
                        let optionClass = 'mt-2 p-3 border-l-4 card rounded-r-md';
                        if (optIndex === q.correctAnswerIndex) optionClass += ' option-btn-correct';
                        else if (userAnswer.selectedIndex === optIndex) optionClass += ' option-btn-incorrect';
                        else optionClass += ' border-default';
                        return `<div class="${optionClass}"><p>${String.fromCharCode(65 + optIndex)}. ${opt.text} ${indicators}</p><p class="text-sm text-secondary mt-1 pl-5"><em>Explanation:</em> ${opt.explanation}</p></div>`;
                    }).join('');
                    questionEl.innerHTML = `<p class="font-semibold text-secondary">Question ${originalIndex + 1} (${q.category})</p><p class="font-bold text-lg mt-1">${q.questionText}</p><div class="mt-4 space-y-2">${optionsHtml}</div>`;
                    container.appendChild(questionEl);
                });
            };
            
            // --- Event Listeners ---
            getEl('timer-start-btn').addEventListener('click', startTimer);
            getEl('timer-pause-btn').addEventListener('click', pauseTimer);
            getEl('question-grid').addEventListener('click', (e) => { if(e.target.matches('button[data-index]')) jumpToQuestion(parseInt(e.target.dataset.index)); });
            getEl('flag-question-btn').addEventListener('click', toggleFlag);
            getEl('question-container').addEventListener('click', handleSelectAnswer);
            getEl('question-container').addEventListener('contextmenu', handleStrikeThrough);
            getEl('finish-test-btn').addEventListener('click', showModal);
            getEl('reset-progress-btn').addEventListener('click', resetState);
            getEl('modal-cancel-btn').addEventListener('click', hideModal);
            getEl('modal-confirm-btn').addEventListener('click', finishTest);
            getEl('modal-backdrop').addEventListener('click', hideModal);
            getEl('view-all-btn').addEventListener('click', () => showDetailedReview('all'));
            getEl('view-incorrect-btn').addEventListener('click', () => showDetailedReview('incorrect'));
            getEl('back-to-summary-btn').addEventListener('click', () => { getEl('detailed-review-view').classList.add('hidden'); getEl('summary-dashboard').classList.remove('hidden'); });
            getEl('tab-test').addEventListener('click', handleTabClick);
            getEl('tab-summary').addEventListener('click', handleTabClick);

            // --- Initial Load ---
            updateThemeIcons();
            createTestSelector();
            if (testsToLoad.length > 0) {
                loadTest(testsToLoad[0]);
            } else {
                getEl('main-content-area').innerHTML = `<p class="text-secondary text-center">No tests found. Please add a test script to the HTML head and add it to the 'testsToLoad' array.</p>`;
            }
        });
    </script>
</body>
</html>
